<!DOCTYPE html>
<html lang="en-CA">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - Film Equipment & Gear for Sale | Rainscope Filmworks</title>
    <meta name="description" content="Purchase professional film equipment in Vancouver, BC. Cameras, lighting, audio gear, and production equipment available for sale. Quality gear with inventory tracking.">
    <meta name="keywords" content="film equipment for sale, buy camera gear, lighting equipment purchase, audio gear sale, production equipment shop, BC film gear">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <link rel="canonical" href="https://rainscopefilmworks.com/shop.html">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="assets/images/android-chrome-512x512.png">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://rainscopefilmworks.com/shop.html">
    <meta property="og:title" content="Shop - Film Equipment for Sale | Rainscope Filmworks">
    <meta property="og:description" content="Purchase professional film equipment in Vancouver, BC. Cameras, lighting, audio gear, and production equipment available.">
    <meta property="og:image" content="https://rainscopefilmworks.com/assets/images/logo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Shop - Film Equipment for Sale - Rainscope Filmworks">
    <meta property="og:locale" content="en_CA">
    <meta property="og:site_name" content="Rainscope Filmworks">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://rainscopefilmworks.com/shop.html">
    <meta name="twitter:title" content="Shop - Film Equipment for Sale | Rainscope Filmworks">
    <meta name="twitter:description" content="Purchase professional film equipment in Vancouver, BC. Cameras, lighting, audio gear, and production equipment available.">
    <meta name="twitter:image" content="https://rainscopefilmworks.com/assets/images/logo.png">
    <meta name="twitter:image:alt" content="Shop - Film Equipment for Sale - Rainscope Filmworks">
    
    <!-- Resource Hints -->
    <link rel="preconnect" href="https://www.googletagmanager.com">
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <link rel="preconnect" href="https://www.google.com">
    <link rel="dns-prefetch" href="https://www.google.com">
    <link rel="preconnect" href="https://js.squareup.com">
    <link rel="dns-prefetch" href="https://js.squareup.com">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" as="image" href="assets/images/logo.png">
    
    <link rel="stylesheet" href="assets/css/styles.css">
    
    <!-- Disable Cloudflare Rocket Loader for this page -->
    <meta name="cf-2fa-verify" content="">
    <script>
      // Disable Rocket Loader
      window._cf_chl_opt = { cv: '1' };
    </script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7RRQQ33JKM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-7RRQQ33JKM');
    </script>
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Store",
      "name": "Rainscope Filmworks Shop",
      "description": "Purchase professional film equipment in Vancouver, BC. Cameras, lighting, audio gear, and production equipment available for sale.",
      "url": "https://rainscopefilmworks.com/shop.html",
      "image": "https://rainscopefilmworks.com/assets/images/logo.png",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "1868 Glen Dr #235",
        "addressLocality": "Vancouver",
        "addressRegion": "BC",
        "postalCode": "V6A 4K4",
        "addressCountry": "CA"
      },
      "telephone": "604-910-2845",
      "email": "Hello@rainscopefilmworks.com"
    }
    </script>
    
    <style>
    /* Shop App Styles */
    :root{
      --rs-bg:#173633; --rs-card:#fff; --rs-text:#131417; --rs-muted:#6b7280;
      --rs-border:rgba(255, 255, 255, 0.1); --rs-accent:#2B3E5E; --rs-radius:12px;
      --rs-gap:clamp(10px, 1.6vw, 16px); --rs-pad:clamp(8px, 1.4vw, 12px);
      --rs-font:clamp(13px, 1.05vw, 15px);
      --rs-chip-h:clamp(32px, 4.8vw, 36px);
      --vh: 1vh;
      --z-shell: 1; --z-sheet: 60; --z-toast: 70;
    }

    .shop-wrapper *{box-sizing:border-box}
    .shop-wrapper .rs{background:var(--rs-bg);color:var(--rs-text);font:var(--rs-font)/1.6 -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif}

    /* centered shell up to 6000px */
    .shop-wrapper .rs-shell{
      width:100%;
      max-width:6000px;
      margin-inline:auto;
      padding-left: calc(20px + env(safe-area-inset-left));
      padding-right: calc(20px + env(safe-area-inset-right));
    }
    
    /* Add side padding on desktop */
    @media (min-width: 961px) {
      .shop-wrapper .rs-shell{
        padding-left: clamp(1.5rem, 3vw, 2.5rem);
        padding-right: clamp(1.5rem, 3vw, 2.5rem);
      }
    }

    /* global padding around everything - removed for edge-to-edge on desktop */
    .shop-wrapper #rs-app{ padding:0; }
    
    /* >>> Full-bleed on mobile: apply to the GRID PARENT so Squarespace gutters don't constrain it */
    @media (max-width:960px){
      .shop-wrapper #rs-app{
        width:100vw;
        max-width:100vw;
        margin-left:calc(50% - 50vw);
        margin-right:calc(50% - 50vw);
        padding-left:10px;
        padding-right:10px;
      }
    }

    /* Layout grid */
    .shop-wrapper #rs-app{
      display:grid;
      gap:var(--rs-gap);
      padding-top:var(--rs-gap);
      padding-bottom:var(--rs-gap);
      grid-template-columns:260px 1fr 420px;
      grid-template-rows:56px 1fr;
      grid-template-areas:"top top top" "cats items cart";
      min-height:calc(100vh - 200px);
    }

    .shop-wrapper .rs-top{
      grid-area:top;
      display:flex;
      align-items:center;
      gap:var(--rs-gap);
      background:#fff;
      border:1px solid #e6e7ea;
      border-radius:var(--rs-radius);
      padding:var(--rs-pad) calc(var(--rs-pad) + 2px);
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .shop-wrapper .rs-search{
      flex:1;
      padding:.7rem .9rem;
      border:1px solid #e6e7ea;
      border-radius:10px;
      font-size:clamp(14px,1.05vw,16px);
      background:#fff;
      color:#131417;
    }
    .shop-wrapper .rs-search:focus{
      outline:none;
      border-color:#2B3E5E;
      box-shadow:0 0 0 3px rgba(43, 62, 94, 0.1);
    }
    .shop-wrapper .rs-toggle{display:none;padding:var(--rs-pad);border:1px solid var(--rs-border);border-radius:var(--rs-radius);background:var(--rs-accent);color:#fff;font:inherit;cursor:pointer}
    .shop-wrapper .rs-only-mobile{display:none}
    .shop-wrapper .rs-cart-toggle{position:relative}
    .shop-wrapper .rs-badge{position:absolute;top:-6px;right:-6px;background:#ef4444;color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700}

    .shop-wrapper .rs-cats{
      grid-area:cats;
      background:var(--rs-card);
      border-radius:var(--rs-radius);
      padding:var(--rs-pad);
      overflow-y:auto;
      min-height:400px;
    }
    .shop-wrapper .rs-cats-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--rs-pad);font-weight:600}
    .shop-wrapper .rs-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--rs-muted)}
    .shop-wrapper .rs-cats-list{display:flex;flex-direction:column;gap:8px}
    .shop-wrapper .rs-cat{
      padding:var(--rs-pad);
      border:1px solid var(--rs-border);
      border-radius:var(--rs-radius);
      background:transparent;
      cursor:pointer;
      text-align:left;
      font:inherit;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:all 0.2s;
    }
    .shop-wrapper .rs-cat:hover{background:rgba(43,62,94,0.1);border-color:var(--rs-accent)}
    .shop-wrapper .rs-cat.active{background:var(--rs-accent);color:#fff;border-color:var(--rs-accent)}
    .shop-wrapper .rs-count{font-size:12px;color:var(--rs-muted);opacity:0.7}
    .shop-wrapper .rs-cat.active .rs-count{color:rgba(255,255,255,0.8)}

    .shop-wrapper .rs-items{
      grid-area:items;
      overflow-y:auto;
      background:var(--rs-card);
      border-radius:var(--rs-radius);
      padding:clamp(1rem, 2vw, 1.5rem);
    }
    .shop-wrapper .rs-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:var(--rs-gap);
      padding:0;
    }
    .shop-wrapper .rs-card{
      background:var(--rs-card);
      border-radius:var(--rs-radius);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      border:1px solid var(--rs-border);
      transition:transform 0.2s,box-shadow 0.2s;
    }
    .shop-wrapper .rs-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    .shop-wrapper .rs-img{
      width:100%;
      aspect-ratio:4/3;
      object-fit:cover;
      background:#f3f4f6;
    }
    .shop-wrapper .rs-body{padding:var(--rs-pad);display:flex;flex-direction:column;gap:8px;flex:1}
    .shop-wrapper .rs-title{font-weight:600;font-size:15px;margin-bottom:4px}
    .shop-wrapper .rs-variant{width:100%;padding:6px;border:1px solid var(--rs-border);border-radius:6px;font:inherit;margin-bottom:4px}
    .shop-wrapper .rs-row{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
    .shop-wrapper .rs-price{font-weight:600;color:var(--rs-accent);font-size:16px}
    .shop-wrapper .rs-inventory{
      font-size:12px;
      color:var(--rs-muted);
      margin-top:4px;
    }
    .shop-wrapper .rs-inventory.in-stock{color:#10b981}
    .shop-wrapper .rs-inventory.low-stock{color:#f59e0b}
    .shop-wrapper .rs-inventory.out-of-stock{color:#ef4444}
    .shop-wrapper .rs-add{
      padding:8px 16px;
      border:1px solid var(--rs-accent);
      border-radius:var(--rs-radius);
      background:var(--rs-accent);
      color:#fff;
      cursor:pointer;
      font-weight:600;
      transition:all 0.2s;
    }
    .shop-wrapper .rs-add:hover{background:#3a5477;border-color:#3a5477}
    .shop-wrapper .rs-add:disabled{opacity:0.5;cursor:not-allowed}

    .shop-wrapper .rs-cart{
      grid-area:cart;
      background:var(--rs-card);
      border-radius:var(--rs-radius);
      display:flex;
      flex-direction:column;
      border:1px solid var(--rs-border);
      max-height:calc(100vh - 120px);
    }
    .shop-wrapper .rs-cart-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:var(--rs-pad);
      border-bottom:1px solid var(--rs-border);
      font-weight:600;
    }
    .shop-wrapper .rs-head-count{font-weight:400;color:var(--rs-muted)}
    .shop-wrapper .rs-cart-scroll{flex:1;overflow-y:auto;padding:var(--rs-pad)}
    .shop-wrapper .rs-cart-lines{display:flex;flex-direction:column;gap:var(--rs-pad)}
    .shop-wrapper .rs-line{
      display:grid;
      grid-template-columns:1fr 80px 32px;
      gap:var(--rs-pad);
      align-items:center;
      padding:var(--rs-pad);
      border:1px solid var(--rs-border);
      border-radius:var(--rs-radius);
    }
    .shop-wrapper .rs-line input[type=number]{width:100%;padding:6px;border:1px solid var(--rs-border);border-radius:6px;text-align:center}
    .shop-wrapper .rs-remove{background:none;border:none;font-size:24px;cursor:pointer;color:var(--rs-muted);line-height:1}
    .shop-wrapper .rs-remove:hover{color:#ef4444}

    .shop-wrapper .rs-cart-footer{
      border-top:1px solid var(--rs-border);
      padding:var(--rs-pad);
      display:flex;
      flex-direction:column;
      gap:var(--rs-pad);
    }
    .shop-wrapper .rs-summary{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:var(--rs-pad);
      background:#f9fafb;
      border-radius:var(--rs-radius);
    }
    .shop-wrapper .rs-total{font-size:18px;margin-top:8px;padding-top:8px;border-top:1px solid var(--rs-border)}
    .shop-wrapper .rs-form{
      display:flex;
      flex-direction:column;
      gap:var(--rs-pad);
    }
    .shop-wrapper .rs-form input,
    .shop-wrapper .rs-form textarea{
      padding:var(--rs-pad);
      border:1px solid var(--rs-border);
      border-radius:var(--rs-radius);
      font:inherit;
    }
    .shop-wrapper .rs-form textarea{resize:vertical;min-height:60px}
    .shop-wrapper .rs-actions{display:flex;flex-direction:column;gap:8px}
    .shop-wrapper .rs-btn-primary{
      padding:12px 24px;
      border:1px solid var(--rs-accent);
      border-radius:12px;
      background:#2B3E5E;
      color:#fff;
      cursor:pointer;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
      transition:all 0.3s ease;
    }
    .shop-wrapper .rs-btn-primary:hover{
      background:#3a5477;
      border-color:#3a5477;
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(43, 62, 94, 0.3);
    }
    .shop-wrapper .rs-btn-primary:active{
      transform:translateY(0);
    }
    .shop-wrapper .rs-btn-primary:disabled{
      opacity:0.6;
      cursor:not-allowed;
      transform:none;
    }
    .shop-wrapper .rs-status{font-size:13px;color:var(--rs-muted);text-align:center}

    /* Square Payment Form Styles */
    .shop-wrapper .square-payment-form{
      margin-top:var(--rs-pad);
      padding:var(--rs-pad);
      background:#f9fafb;
      border-radius:var(--rs-radius);
    }
    .shop-wrapper .square-payment-form label{
      display:block;
      margin-bottom:8px;
      font-weight:600;
      font-size:14px;
    }
    .shop-wrapper #card-container{
      margin-bottom:var(--rs-pad);
    }
    /* Square Web Payments SDK v1 styles */
    .shop-wrapper #card-container .sq-input-field,
    .shop-wrapper #card-container iframe{
      width:100%;
      min-height:40px;
    }
    /* Legacy SqPaymentForm styles (for backwards compatibility) */
    .shop-wrapper #card-container > div{
      padding:var(--rs-pad);
      border:1px solid var(--rs-border);
      border-radius:6px;
      background:#fff;
      margin-bottom:8px;
    }
    .shop-wrapper .sq-input{
      font-size:16px;
      padding:12px;
      border:1px solid #e6e7ea;
      border-radius:6px;
      width:100%;
      box-sizing:border-box;
    }
    .shop-wrapper .sq-input:focus{
      outline:none;
      border-color:var(--rs-accent);
      box-shadow:0 0 0 3px rgba(43,62,94,0.1);
    }

    .shop-wrapper .rs-toast{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%) translateY(100px);
      background:#2B3E5E;
      color:#fff;
      padding:12px 24px;
      border-radius:var(--rs-radius);
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      z-index:var(--z-toast);
      opacity:0;
      transition:opacity 0.2s,transform 0.2s;
      pointer-events:none;
    }
    .shop-wrapper .rs-toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }

    /* Tablet */
    @media (max-width:1100px){
      .shop-wrapper #rs-app{grid-template-columns:220px 1fr 360px}
    }

    /* Mobile stacks */
    @media (max-width:960px){
      .shop-wrapper #rs-app{grid-template-columns:1fr;grid-template-rows:auto auto auto auto;grid-template-areas:"top" "cats" "items" "cart"}
      .shop-wrapper .rs-only-mobile{display:inline-flex}
      .shop-wrapper .rs-cats{min-height:auto}
      /* mobile chips scroll horizontally */
      .shop-wrapper .rs-cats-list{flex-direction:row;flex-wrap:nowrap}
      .shop-wrapper .rs-cat{min-width:180px;flex-shrink:0}
      .shop-wrapper .rs-line{grid-template-columns:1fr 90px 24px}
      .shop-wrapper .rs-cart{max-height:none;position:fixed;top:0;right:-100%;width:100%;max-width:420px;z-index:var(--z-sheet);transition:right 0.3s}
      .shop-wrapper .rs-cart[data-open="true"]{right:0}
      body.rs-lock{overflow:hidden}
    }

    /* Page content wrapper */
    .page-content {
      margin-top: clamp(66px, calc(70px + 2.75rem), 80px);
      padding: 0;
      background: #173633;
      color: white;
      min-height: calc(100vh - clamp(66px, calc(70px + 2.75rem), 80px));
    }

    .shop-wrapper {
      width: 100%;
      margin: 0;
      padding: clamp(2.75rem, 3.75vw, 3.75rem) 0 clamp(1rem, 2vw, 1.5rem) 0;
    }
    
    .shop-wrapper h1 {
      padding: 0 clamp(1rem, 3vw, 2rem);
      margin-bottom: clamp(1rem, 2vw, 2rem);
      color: white;
      font-size: clamp(2rem, 4vw, 3rem);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <img src="assets/images/logo.png" alt="Rainscope Filmworks" class="logo-img" width="120" height="40" fetchpriority="high">
            </a>
            <button class="mobile-menu-toggle" aria-label="Toggle menu" aria-expanded="false">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            <div class="nav-overlay" id="nav-overlay"></div>
            <nav class="nav" id="main-nav">
                <a href="our-work.html" class="nav-link">Our work</a>
                <a href="rentals.html" class="nav-link">Rentals</a>
                <a href="our-team.html" class="nav-link">Our team</a>
                <a href="contact.html" class="nav-link">Contact us</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="page-content">
        <div class="shop-wrapper">
           
            
            <div id="rs-app" class="rs">
              <header class="rs-top rs-shell">
                <button class="rs-toggle rs-only-mobile" id="rs-open-cats" aria-expanded="false" aria-controls="rs-cats">Filters</button>
                <input id="rs-search" type="search" placeholder="Search items..." class="rs-search" />
                <button class="rs-toggle rs-only-mobile rs-cart-toggle" id="rs-open-cart" aria-expanded="false" aria-controls="rs-cart">
                  Cart <span id="rs-cart-badge" class="rs-badge" hidden>0</span>
                </button>
              </header>

              <aside class="rs-cats rs-shell" id="rs-cats" aria-label="Categories">
                <div class="rs-cats-head">
                  <span>Categories</span>
                  <button class="rs-close rs-only-mobile" id="rs-close-cats" aria-label="Close filters">✕</button>
                </div>
                <div id="rs-cats-list" class="rs-cats-list" role="tablist"></div>
              </aside>

              <main class="rs-items rs-shell">
                <div id="rs-grid" class="rs-grid" aria-live="polite"></div>
              </main>

              <!-- Cart -->
              <aside class="rs-cart" id="rs-cart" aria-label="Cart / Checkout" data-open="false">
                <div class="rs-cart-head">
                  <span>Cart <span id="rs-cart-count" class="rs-head-count" hidden>(0)</span> / Checkout</span>
                  <button class="rs-close rs-only-mobile" id="rs-close-cart" aria-label="Close cart">✕</button>
                </div>

                <div class="rs-cart-scroll">
                  <div id="rs-cart-lines" class="rs-cart-lines"></div>
                </div>

                <div class="rs-cart-footer">
                  <div class="rs-summary">
                    <div class="rs-total">Total: <strong id="rs-total">—</strong></div>
                  </div>

                  <div class="rs-form">
                    <input id="first" placeholder="First name *" />
                    <input id="last" placeholder="Last name" />
                    <input id="email" type="email" placeholder="Email *" />
                    <input id="phone" placeholder="Phone (optional)" />
                    <textarea id="note" rows="3" placeholder="Optional notes"></textarea>

                    <!-- Square Payment Form -->
                    <div class="square-payment-form">
                      <label>Payment Information *</label>
                      <div id="card-container">
                        <!-- Square Web Payments SDK v1 will create card input fields here -->
                      </div>
                    </div>

                    <div class="rs-actions">
                      <button id="rs-submit" class="rs-btn-primary">Complete Purchase</button>
                      <span id="rs-status" class="rs-status"></span>
                    </div>
                  </div>
                </div>
              </aside>

              <!-- Toast -->
              <div id="rs-toast" class="rs-toast" hidden>Added to cart</div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-section footer-location">
                <h4>LOCATION</h4>
                <div class="map-container">
                    <iframe 
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2602.1234567890!2d-123.0806155!3d49.2683796!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zNDnCsDE2JzA2LjIiTiAxMjPCsDA0JzUwLjIiVw!5e0!3m2!1sen!2sca!4v1234567890123!5m2!1sen!2sca" 
                        width="100%" 
                        height="100%" 
                        style="border:0;" 
                        allowfullscreen="" 
                        loading="lazy" 
                        referrerpolicy="no-referrer-when-downgrade"
                        title="Rainscope Filmworks Location Map">
                    </iframe>
                </div>
                <p>1868 Glen Dr #235<br>Vancouver, BC, V6A 4K4</p>
            </div>
            <div class="footer-section footer-hours">
                <h4>HOURS</h4>
                <p>Monday - Friday<br>9am - 5pm</p>
                <p>Saturday - Sunday<br>Upon request</p>
            </div>
            <div class="footer-section footer-contact">
                <h4>CONTACT</h4>
                <p>
                    <a href="mailto:Hello@rainscopefilmworks.com">Hello@Rainscopefilmworks.com</a><br>
                    <a href="mailto:rentals@rainscopefilmworks.com">Rentals@RainscopeFilmworks.com</a>
                </p>
                <div class="social-links">
                    <a href="mailto:Hello@rainscopefilmworks.com" aria-label="Email">
                        <svg viewBox="0 0 64 64" width="32" height="32">
                            <path d="M17,22v20h30V22H17z M41.1,25L32,32.1L22.9,25H41.1z M20,39V26.6l12,9.3l12-9.3V39H20z"/>
                        </svg>
                    </a>
                    <a href="https://www.instagram.com/rainscopefilmworks/" target="_blank" aria-label="Instagram">
                        <svg viewBox="0 0 64 64" width="32" height="32">
                            <path d="M46.91,25.816c-0.073-1.597-0.326-2.687-0.697-3.641c-0.383-0.986-0.896-1.823-1.73-2.657c-0.834-0.834-1.67-1.347-2.657-1.73c-0.954-0.371-2.045-0.624-3.641-0.697C36.585,17.017,36.074,17,32,17s-4.585,0.017-6.184,0.09c-1.597,0.073-2.687,0.326-3.641,0.697c-0.986,0.383-1.823,0.896-2.657,1.73c-0.834,0.834-1.347,1.67-1.73,2.657c-0.371,0.954-0.624,2.045-0.697,3.641C17.017,27.415,17,27.926,17,32c0,4.074,0.017,4.585,0.09,6.184c0.073,1.597,0.326,2.687,0.697,3.641c0.383,0.986,0.896,1.823,1.73,2.657c0.834,0.834,1.67,1.347,2.657,1.73c0.954,0.371,2.045,0.624,3.641,0.697C27.415,46.983,27.926,47,32,47s4.585-0.017,6.184-0.09c1.597-0.073,2.687-0.326,3.641-0.697c0.986-0.383,1.823-0.896,2.657-1.73c0.834-0.834,1.347-1.67,1.73-2.657c0.371-0.954,0.624-2.045,0.697-3.641C46.983,36.585,47,36.074,47,32S46.983,27.415,46.91,25.816z M32,39.703c-4.254,0-7.703-3.449-7.703-7.703s3.449-7.703,7.703-7.703s7.703,3.449,7.703,7.703S36.254,39.703,32,39.703z M40.007,25.793c-0.994,0-1.8-0.806-1.8-1.8c0-0.994,0.806-1.8,1.8-1.8c0.994,0,1.8,0.806,1.8,1.8C41.807,24.987,41.001,25.793,40.007,25.793z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Skip script.js on shop page to avoid Rocket Loader issues with testimonials slider -->
    <!-- Only load mobile menu functionality inline -->
    <script data-cfasync="false">
    // Minimal mobile menu functionality for shop page
    document.addEventListener('DOMContentLoaded', function() {
        const menuToggle = document.querySelector('.mobile-menu-toggle');
        const nav = document.querySelector('#main-nav');
        const navOverlay = document.querySelector('#nav-overlay');
        const navLinks = document.querySelectorAll('.nav-link');
        
        if (menuToggle && nav) {
            function closeMenu() {
                nav.classList.remove('active');
                navOverlay.classList.remove('active');
                menuToggle.setAttribute('aria-expanded', 'false');
                document.body.style.overflow = '';
            }
            
            menuToggle.addEventListener('click', () => {
                const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';
                menuToggle.setAttribute('aria-expanded', String(!isExpanded));
                nav.classList.toggle('active');
                if (navOverlay) navOverlay.classList.toggle('active');
                document.body.style.overflow = isExpanded ? '' : 'hidden';
            });
            
            if (navOverlay) {
                navOverlay.addEventListener('click', closeMenu);
            }
            
            navLinks.forEach(link => {
                link.addEventListener('click', closeMenu);
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && nav.classList.contains('active')) {
                    closeMenu();
                }
            });
        }
    });
    </script>
    
    <!-- Square Web Payments SDK - Load dynamically to avoid Rocket Loader -->
    <script data-cfasync="false">
      // Load Square script dynamically and set up callback
      (function() {
        window.squareScriptReady = false;
        const script = document.createElement('script');
        script.type = 'text/javascript';
        // Updated Square Web Payments SDK URL (v1)
        script.src = 'https://web.squarecdn.com/v1/square.js';
        script.setAttribute('data-cfasync', 'false');
        script.async = false; // Load synchronously to ensure it's available
        script.crossOrigin = 'anonymous';
        script.onload = function() {
          window.squareScriptLoaded = true;
          window.squareScriptReady = true;
          console.log('Square Web Payments SDK loaded successfully');
          // Check for both possible Square SDK objects
          if (typeof SqPaymentForm !== 'undefined' || (window.Square && window.Square.payments)) {
            if (typeof window.onSquareScriptLoaded === 'function') {
              window.onSquareScriptLoaded();
            }
          } else {
            console.warn('Square script loaded but SqPaymentForm not found. Available:', Object.keys(window).filter(k => k.toLowerCase().includes('square')));
          }
        };
        script.onerror = function(error) {
          console.error('Failed to load Square Web Payments SDK:', error);
          console.error('Check: 1) Network connection, 2) Domain whitelisted in Square Dashboard, 3) Ad blockers');
          window.squareScriptLoadError = true;
          window.squareScriptReady = false;
        };
        document.head.appendChild(script);
      })();
    </script>
    
    <script>
    // Wait for DOM to be fully ready, then initialize
    (async function initShopApp() {
      // Ensure DOM is ready
      if (document.readyState === 'loading') {
        await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
      }
      
      // Wait for Square script to load with longer timeout
      let squareLoadAttempts = 0;
      const maxAttempts = 50; // 5 seconds total (in case of slow connection)
      // Check for both old (SqPaymentForm) and new (Square.payments) API
      while (typeof SqPaymentForm === 'undefined' && !(window.Square && window.Square.payments) && squareLoadAttempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        squareLoadAttempts++;
        // Check if script failed to load
        if (window.squareScriptLoadError) {
          console.error('Square script failed to load - stopping wait');
          break;
        }
      }
      
      console.log('Square script check complete:', {
        SqPaymentForm: typeof SqPaymentForm,
        Square: typeof window.Square,
        SquarePayments: window.Square && typeof window.Square.payments,
        squareScriptLoaded: window.squareScriptLoaded,
        squareScriptReady: window.squareScriptReady,
        attempts: squareLoadAttempts,
        availableGlobals: Object.keys(window).filter(k => k.toLowerCase().includes('square'))
      });
      
      (async () => {
      const PROXY_BASE  = "https://rainscope-square-proxy.sweet-queen-15c3.workers.dev";
      const LOCATION_ID = "L5CDX7TRVDN0C";
      // Filter for shop items - only show "Stuck on set" category
      const EXCLUDE_CATEGORY_NAMES = ["labour","services","service","A tile on the streets","hidden"];
      // Only include items in "Stuck on set" category
      const SHOP_CATEGORY_NAMES = ["stuck on set"];
      const normalize = s => (s||"").toLowerCase().replace(/&/g," and ").replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim();
      const excludeSet = new Set(EXCLUDE_CATEGORY_NAMES.map(normalize));
      const shopSet = new Set(SHOP_CATEGORY_NAMES.map(normalize));
      
      // Debug mode: set to true to bypass location filtering
      const DEBUG_MODE = false;
      // Temporary: set to true to show all items regardless of category (for debugging)
      const DEBUG_SHOW_ALL_CATEGORIES = false;
      // Temporary: set to true to show items even with 0 inventory (for debugging)
      const DEBUG_SHOW_ZERO_INVENTORY = false;

      // DOM
      const $cats = document.getElementById("rs-cats-list");
      const $grid = document.getElementById("rs-grid");
      const $search = document.getElementById("rs-search");
      const $lines = document.getElementById("rs-cart-lines");
      const $submit = document.getElementById("rs-submit");
      const $status = document.getElementById("rs-status");
      const $total = document.getElementById("rs-total");
      const $cartPanel = document.getElementById("rs-cart");
      const $openCart = document.getElementById("rs-open-cart");
      const $closeCart = document.getElementById("rs-close-cart");
      const $badge = document.getElementById("rs-cart-badge");
      const $count = document.getElementById("rs-cart-count");
      const $toast = document.getElementById("rs-toast");
      const $cardContainer = document.getElementById("card-container");

      if (!$cats || !$grid) {
        console.error("Critical DOM elements missing!");
        if ($grid) $grid.innerHTML = "<em style='color:red;'>Error: Page structure incomplete. Please refresh.</em>";
        return;
      }

      // State
      let objects=[], items=[], categories=[], imagesById={};
      let activeCat="all";
      const cart = JSON.parse(localStorage.getItem("shop_cart") || "[]");
      let inventoryCache = {}; // Cache inventory counts
      let payments = null; // Square Payments instance (v1 API)
      let card = null; // Square Card payment method instance

      // Initialize Square Payments
      // ============================================
      // CONFIGURATION:
      // 1. Application ID is configured below
      // 2. In Square Developer Dashboard, add your domain to allowed origins:
      //    - Go to your app → Settings → Point of Sale API (or Web Payments SDK)
      //    - Add: https://rainscopefilmworks.com (and http://localhost for testing)
      // ============================================
      const APPLICATION_ID = "sq0idp-Q4C4Lb_w5aFXTJuE_2ebgg"; // Square Application ID
      
      // Initialize Square payment form (after waiting for script above)
      if (APPLICATION_ID) {
        // Check for new Square.payments API (v1)
        if (window.Square && window.Square.payments) {
          try {
            await initializeSquarePayments();
          } catch (sqError) {
            console.error("Error initializing Square payment form:", sqError);
            console.error("Square SDK available objects:", Object.keys(window.Square || {}));
            if ($cardContainer) {
              $cardContainer.innerHTML = "<p style='color:#ef4444;font-size:12px;'>Payment form initialization failed. Check console for details.</p>";
            }
          }
        } else if (typeof SqPaymentForm !== 'undefined') {
          // Fallback: old SqPaymentForm API (deprecated but still supported temporarily)
          console.warn("Using deprecated SqPaymentForm API. Consider migrating to Square.payments()");
          try {
            initializeSquarePaymentsLegacy();
          } catch (sqError) {
            console.error("Error initializing legacy Square payment form:", sqError);
            if ($cardContainer) {
              $cardContainer.innerHTML = "<p style='color:#ef4444;font-size:12px;'>Payment form initialization failed. Check console for details.</p>";
            }
          }
        } else {
          console.error("Square Web Payments SDK not available. Payment form will not work.");
          console.log("Square script loaded:", window.squareScriptLoaded);
          console.log("Square object:", typeof window.Square);
          console.log("SqPaymentForm type:", typeof SqPaymentForm);
          console.log("Available globals with 'square':", Object.keys(window).filter(k => k.toLowerCase().includes('square')));
          if ($cardContainer) {
            $cardContainer.innerHTML = "<p style='color:#ef4444;font-size:12px;'>Payment form failed to load. Check: 1) Domain whitelisted in Square Dashboard, 2) Ad blockers disabled, 3) Console for details.</p>";
          }
        }
      } else {
        console.warn("Square Application ID not configured. Payment processing will not work.");
        if ($cardContainer) {
          $cardContainer.innerHTML = "<p style='color:#ef4444;font-size:12px;'>Payment form not configured. Please set APPLICATION_ID.</p>";
        }
      }

      // New Square Web Payments SDK v1 API
      async function initializeSquarePayments() {
        // Initialize Square Payments
        payments = Square.payments(APPLICATION_ID, LOCATION_ID);
        
        // Create and attach card payment method
        card = await payments.card();
        await card.attach('#card-container');
        
        console.log('Square Web Payments SDK v1 initialized successfully');
      }

      // Legacy SqPaymentForm API (for backwards compatibility)
      function initializeSquarePaymentsLegacy() {
        payments = new SqPaymentForm({
          applicationId: APPLICATION_ID,
          locationId: LOCATION_ID,
          inputClass: 'sq-input',
          cardNumber: {
            elementId: 'sq-card-number',
            placeholder: 'Card Number'
          },
          cvv: {
            elementId: 'sq-cvv',
            placeholder: 'CVV'
          },
          expirationDate: {
            elementId: 'sq-expiration-date',
            placeholder: 'MM/YY'
          },
          postalCode: {
            elementId: 'sq-postal-code',
            placeholder: 'Postal Code'
          },
          callbacks: {
            cardNonceResponseReceived: function(errors, nonce, cardData) {
              if (errors) {
                $status.textContent = "Payment error: " + errors[0].message;
                $submit.disabled = false;
                return;
              }
              // Process payment with nonce
              processPurchase(nonce);
            },
            unsupportedBrowserDetected: function() {
              console.error("Unsupported browser");
            },
            inputEventReceived: function(inputEvent) {
              // Handle input events if needed
            }
          }
        });
        payments.build();
      }

      // Money + totals
      const money = n => n.toLocaleString(undefined,{style:"currency",currency:"CAD"});
      const priceNum = pm => pm && typeof pm.amount==="number" ? pm.amount/100 : 0;

      function showToast(msg="Added to cart"){
        if(!$toast) return;
        $toast.textContent = msg;
        $toast.hidden = false;
        requestAnimationFrame(()=> $toast.classList.add("show"));
        setTimeout(()=>{ $toast.classList.remove("show"); setTimeout(()=> $toast.hidden=true, 200); }, 1200);
      }

      function itemCatId(it){ return it?.item_data?.category_id
        || it?.item_data?.reporting_category?.id
        || (it?.item_data?.categories?.[0]?.id ?? null); }

      function updateBadges(){
        const units = cart.reduce((n,l)=> n + Math.max(1,parseInt(l.qty||"1",10)), 0);
        if($badge){ if(units>0){ $badge.textContent=String(units); $badge.hidden=false; } else $badge.hidden=true; }
        if($count){ if(units>0){ $count.textContent = `(${units})`; $count.hidden=false; } else $count.hidden=true; }
      }

      function computeTotals(){
        const total = cart.reduce((sum,l)=> sum + priceNum(l.priceMoney) * Math.max(1,parseInt(l.qty||"1",10)), 0);
        $total.textContent = total ? money(total) : "—";
      }

      function saveCart(){ localStorage.setItem("shop_cart", JSON.stringify(cart)); }
      
      function renderCart(){
        if(!cart.length){ $lines.innerHTML = "<em>No items yet.</em>"; updateBadges(); computeTotals(); return; }
        $lines.innerHTML = cart.map((l,i)=>`
          <div class="rs-line">
            <div>
              <div>${l.name}</div>
              <div style="font-size:12px;color:#6b7280">${l.priceMoney? money(priceNum(l.priceMoney)):"—"}</div>
            </div>
            <input type="number" min="1" max="${l.maxQty || 999}" data-i="${i}" value="${l.qty}">
            <button class="rs-remove" data-rm="${i}">&times;</button>
          </div>`).join("");
        $lines.querySelectorAll("input[type=number]").forEach(inp=>{
          inp.onchange=e=>{ 
            const i=+e.target.dataset.i; 
            const newQty = Math.max(1, Math.min(parseInt(e.target.value||"1",10), cart[i].maxQty || 999));
            cart[i].qty=String(newQty); 
            saveCart(); 
            updateBadges(); 
            computeTotals(); 
          };
        });
        $lines.querySelectorAll("[data-rm]").forEach(btn=>{
          btn.onclick=()=>{ cart.splice(+btn.dataset.rm,1); saveCart(); renderCart(); };
        });
        updateBadges(); computeTotals();
      }

      function openCart(){
        $cartPanel.dataset.open = "true";
        document.documentElement.classList.add('rs-lock');
        document.body.classList.add('rs-lock');
        $openCart?.setAttribute("aria-expanded","true");
      }
      
      function closeCart(){
        $cartPanel.dataset.open = "false";
        document.documentElement.classList.remove('rs-lock');
        document.body.classList.remove('rs-lock');
        $openCart?.setAttribute("aria-expanded","false");
      }

      // Load inventory for items
      async function loadInventory(catalogObjectIds){
        if(!catalogObjectIds || catalogObjectIds.length === 0) return {};
        try {
          const ids = catalogObjectIds.join(",");
          const response = await fetch(`${PROXY_BASE}/api/inventory?catalog_object_ids=${ids}`);
          if(!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          return data.counts || {};
        } catch(err){
          console.error("Error loading inventory:", err);
          return {};
        }
      }

      function addToCart(variationId, name, priceMoney, maxQty){
        const line = cart.find(l=>l.variationId===variationId);
        if(line) {
          const newQty = Math.min((+line.qty||1)+1, maxQty || 999);
          if(newQty > (+line.qty||1)) {
            line.qty = String(newQty);
            saveCart(); renderCart(); showToast();
          } else {
            showToast("Maximum quantity reached");
          }
        } else {
          cart.push({variationId,name,priceMoney,qty:"1",maxQty});
          saveCart(); renderCart(); showToast();
        }
      }

      async function loadCatalog(){
        try {
          console.log("Loading catalog from:", `${PROXY_BASE}/api/catalog`);
          $grid.innerHTML = "<em>Loading catalog...</em>";
          
          const response = await fetch(`${PROXY_BASE}/api/catalog?bust=${Date.now()}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          console.log("API Response:", data);
          
          if (!data || typeof data !== 'object') {
            throw new Error("Invalid API response format");
          }
          
          objects    = Array.isArray(data.objects) ? data.objects : [];
          console.log(`Loaded ${objects.length} objects from API`);
          
          imagesById = Object.fromEntries(objects.filter(o=>o.type==="IMAGE" && o.image_data).map(o=>[o.id,o]));
          categories = objects.filter(o => o.type==="CATEGORY" && !o.is_deleted && o.category_data);
          const itemsRaw = objects.filter(o => o.type==="ITEM" && !o.is_deleted && o.item_data);
          
          console.log(`Found ${categories.length} categories and ${itemsRaw.length} items`);

          const nameById = Object.fromEntries(categories.map(c => [c.id, c.category_data.name]));
          
          // Debug: Log all category names to help with matching
          console.log("Available categories:", Object.values(nameById));
          console.log("Looking for category:", SHOP_CATEGORY_NAMES);
          const normalizedCategories = Object.values(nameById).map(n => ({ original: n, normalized: normalize(n) }));
          console.log("Normalized categories:", normalizedCategories);

          // Filter items for shop (you can customize this logic)
          items = itemsRaw.filter(it=>{
            const pt=(it.item_data?.product_type||"REGULAR").toUpperCase();
            if(pt!=="REGULAR") {
              console.log(`Item ${it.item_data?.name} filtered: product_type is ${pt}`);
              return false;
            }
            const cid=itemCatId(it);
            if(cid){
              const norm=normalize(nameById[cid]||"");
              if(excludeSet.has(norm)) {
                console.log(`Item ${it.item_data?.name} filtered: category "${nameById[cid]}" is excluded`);
                return false;
              }
              // Only show items in "Stuck on set" category (unless debug mode)
              if(shopSet.size > 0 && !shopSet.has(norm)) {
                if (!DEBUG_SHOW_ALL_CATEGORIES) {
                  console.log(`Item ${it.item_data?.name} filtered: not in "Stuck on set" category (category: "${nameById[cid]}", normalized: "${norm}")`);
                  return false;
                } else {
                  console.log(`DEBUG: Including item ${it.item_data?.name} from category "${nameById[cid]}" (would normally be filtered)`);
                }
              }
            } else {
              // Items without a category are excluded
              console.log(`Item ${it.item_data?.name} filtered: no category assigned`);
              return false;
            }
            
            // Location filtering
            if (!DEBUG_MODE) {
              const locs=it.present_at_location_ids||it.item_data?.present_at_location_ids||[];
              const absent=it.absent_at_location_ids||it.item_data?.absent_at_location_ids||[];
              if(absent.includes(LOCATION_ID)) {
                console.log(`Item ${it.item_data?.name} filtered: absent at location ${LOCATION_ID}`);
                return false;
              }
              const locationMatch = (locs.length===0 || locs.includes(LOCATION_ID));
              if (!locationMatch) {
                console.log(`Item ${it.item_data?.name} filtered: not present at location ${LOCATION_ID}`, {locs, LOCATION_ID});
              }
              return locationMatch;
            } else {
              console.log(`DEBUG MODE: Item ${it.item_data?.name} included (location filtering bypassed)`);
              return true;
            }
          });
          
          console.log(`After filtering: ${items.length} items remain (from ${itemsRaw.length} raw items)`);
          
          // If no items after category filtering, show error immediately
          if (items.length === 0) {
            console.warn("⚠️ All items were filtered out! Check filtering logic.");
            if (itemsRaw.length > 0) {
              console.log("Sample raw item:", itemsRaw[0]);
              console.log("Sample item category:", itemsRaw[0]?.item_data?.category_id ? nameById[itemsRaw[0].item_data.category_id] : "No category");
              // Show a helpful message in the UI
              if ($grid) {
                $grid.innerHTML = `<div style='padding: 2rem; text-align: center; color: #666;'>
                  <p><strong>No items found in "Stuck on set" category.</strong></p>
                  <p style='font-size: 14px; margin-top: 1rem;'>Available categories: ${Object.values(nameById).length > 0 ? Object.values(nameById).join(", ") : "None found"}</p>
                  <p style='font-size: 12px; margin-top: 0.5rem; color: #999;'>Check the browser console for detailed filtering information.</p>
                  <p style='font-size: 12px; margin-top: 0.5rem; color: #999;'>Total items in catalog: ${itemsRaw.length}</p>
                </div>`;
              }
            } else {
              // No items at all in catalog
              if ($grid) {
                $grid.innerHTML = `<div style='padding: 2rem; text-align: center; color: #666;'>
                  <p><strong>No items found in catalog.</strong></p>
                  <p style='font-size: 12px; margin-top: 0.5rem; color: #999;'>Check the browser console for API errors.</p>
                </div>`;
              }
            }
            // Don't continue with inventory loading if no items
            return;
          }

          // Load inventory for all variations
          const allVariationIds = [];
          items.forEach(item => {
            const vars = item.item_data?.variations || [];
            vars.forEach(v => allVariationIds.push(v.id));
          });
          
          if (allVariationIds.length > 0) {
            try {
              const inventoryData = await loadInventory(allVariationIds);
              inventoryCache = inventoryData;

              // Filter out items with no stock (all variations have 0 inventory)
              const itemsBeforeInventory = items.length;
              items = items.filter(item => {
                const vars = item.item_data?.variations || [];
                if (vars.length === 0) return false; // No variations = exclude
                
                // Check if at least one variation has stock
                const hasStock = vars.some(v => {
                  const inv = inventoryCache[v.id] || {quantity: 0};
                  return inv.quantity > 0;
                });
                
                if (!hasStock) {
                  if (DEBUG_SHOW_ZERO_INVENTORY) {
                    console.log(`DEBUG: Including item ${item.item_data?.name} with 0 inventory (would normally be filtered)`);
                    return true;
                  } else {
                    console.log(`Item ${item.item_data?.name} filtered: no stock available`);
                    return false;
                  }
                }
                return hasStock;
              });
              console.log(`After inventory filtering: ${items.length} items remain (from ${itemsBeforeInventory})`);
              
              // If all items filtered out by inventory, show message
              if (items.length === 0 && itemsBeforeInventory > 0 && !DEBUG_SHOW_ZERO_INVENTORY) {
                console.warn("⚠️ All items filtered out due to zero inventory");
                if ($grid) {
                  $grid.innerHTML = `<div style='padding: 2rem; text-align: center; color: #666;'>
                    <p><strong>No items with available inventory.</strong></p>
                    <p style='font-size: 12px; margin-top: 0.5rem; color: #999;'>All items in "Stuck on set" category have zero stock.</p>
                    <p style='font-size: 12px; margin-top: 0.5rem; color: #999;'>Check the browser console for details.</p>
                  </div>`;
                }
                return;
              }
            } catch (invError) {
              console.error("Error loading inventory, showing all items:", invError);
              // If inventory fails, show all items but mark inventory as unknown
              inventoryCache = {};
            }
          } else {
            console.warn("No variations found to check inventory");
            inventoryCache = {};
          }

          const counts=new Map(); let unassigned=0;
          for(const it of items){
            const cid=itemCatId(it);
            if(cid){
              const norm=normalize(nameById[cid]||"");
              if(excludeSet.has(norm)) continue;
              counts.set(cid,(counts.get(cid)||0)+1);
            } else unassigned++;
          }

          const chips=[{id:"all",name:"All",count:items.length}];
          const entries=[...counts.entries()].map(([cid,n])=>({id:cid,name:nameById[cid]||"Category",count:n}));
          entries.sort((a,b)=>a.name.localeCompare(b.name));
          chips.push(...entries);
          if(unassigned>0) chips.push({id:"__unassigned",name:"Unassigned",count:unassigned});

          if (!$cats) {
            console.error("Categories container not found!");
            return;
          }

          $cats.innerHTML = chips.map(c=>`
            <button class="rs-cat ${c.id===activeCat?'active':''}" data-cat="${c.id}" role="tab" aria-selected="${c.id===activeCat}">
              <span>${c.name}</span> <span class="rs-count">${c.count}</span>
            </button>`).join("");

          $cats.querySelectorAll("[data-cat]").forEach(b=>{
            b.onclick=()=>{ activeCat=b.dataset.cat; $cats.querySelectorAll(".rs-cat").forEach(x=>x.classList.remove("active")); b.classList.add("active"); renderGrid(); };
          });
          
          console.log(`Rendered ${chips.length} category chips`);
          renderGrid();
        } catch (error) {
          console.error("Error loading catalog:", error);
          const errorMsg = error.message || "Unknown error";
          
          let displayMsg = errorMsg;
          if (errorMsg.includes("Failed to fetch") || errorMsg.includes("CORS")) {
            const isLocalFile = window.location.protocol === "file:";
            if (isLocalFile) {
              displayMsg = "CORS Error: This page must be served from a web server (not opened as a file). The API only allows requests from https://rainscopefw.squarespace.com. This will work when deployed to your website.";
            } else {
              displayMsg = "CORS Error: The API server is not allowing requests from this origin. Please check the API CORS configuration.";
            }
          }
          
          if ($grid) {
            $grid.innerHTML = `<div style='color:red; padding: 2rem; text-align: center;'><strong>Error loading catalog:</strong><br>${displayMsg}<br><br><small>Check the browser console for more details.</small></div>`;
          }
          if ($cats) {
            $cats.innerHTML = "<em style='color:red;'>Unable to load categories</em>";
          }
        }
      }

      function inCat(it){
        if(activeCat==="all") return true;
        if(activeCat==="__unassigned") return !itemCatId(it);
        return itemCatId(it)===activeCat;
      }

      function renderGrid(){
        if (!$grid) {
          console.error("Grid container not found!");
          return;
        }
        
        console.log(`renderGrid called with ${items.length} items, activeCat: ${activeCat}`);
        
        const q=($search?.value||"").toLowerCase().trim();
        const list=items.filter(it=>{
          if(!inCat(it)) {
            console.log(`Item ${it.item_data?.name} filtered by category`);
            return false;
          }
          if(!q) return true;
          const nameMatch = (it.item_data?.name||"").toLowerCase().includes(q);
          if (!nameMatch) {
            console.log(`Item ${it.item_data?.name} filtered by search query: "${q}"`);
          }
          return nameMatch;
        });

        console.log(`Rendering ${list.length} items (filtered from ${items.length} total, search: "${q}")`);

        if(!list.length){ 
          if (items.length === 0) {
            $grid.innerHTML="<em>No items available. Please check the console for details.</em>"; 
          } else {
            $grid.innerHTML="<em>No items match your search or category filter.</em>"; 
          }
          return; 
        }
        list.sort((a,b)=> (a.item_data?.name||"").localeCompare(b.item_data?.name||""));

        $grid.innerHTML = list.map(item=>{
          const vars=item.item_data?.variations||[];
          const first=vars[0];
          const imgId=item.item_data?.image_ids?.[0];
          const img=imgId?(imagesById[imgId]?.image_data?.url||""):"";
          const title=item.item_data?.name||"Item";

          const opts = vars.map(v=>{
            const d=v.item_variation_data||{};
            const p=d.price_money||null;
            const pjson = p ? JSON.stringify(p).replace(/"/g,'&quot;') : "";
            const priceTxt = p ? (p.amount/100).toLocaleString(undefined,{style:"currency",currency:"CAD"}) : "";
            const inv = inventoryCache[v.id] || {quantity: 0};
            const invText = inv.quantity > 0 ? ` (${inv.quantity} in stock)` : " (Out of stock)";
            return `<option value="${v.id}" data-price="${pjson}" data-inventory="${inv.quantity}">${d.name||"Default"}${priceTxt? " — "+priceTxt:""}${invText}</option>`;
          }).join("");

          const firstPrice = first?.item_variation_data?.price_money || null;
          const firstInv = inventoryCache[first?.id] || {quantity: 0};
          const invClass = firstInv.quantity === 0 ? "out-of-stock" : firstInv.quantity <= 3 ? "low-stock" : "in-stock";
          const invText = firstInv.quantity === 0 ? "Out of stock" : firstInv.quantity <= 3 ? `Low stock (${firstInv.quantity})` : `In stock (${firstInv.quantity})`;

          return `
            <div class="rs-card">
              ${img? `<img class="rs-img" loading="lazy" src="${img}" alt="${title}">` : `<div class="rs-img"></div>`}
              <div class="rs-body">
                <div class="rs-title">${title}</div>
                <select class="rs-variant" data-item="${item.id}">${opts}</select>
                <div class="rs-inventory ${invClass}">${invText}</div>
                <div class="rs-row">
                  <div class="rs-price" data-price-for="${item.id}">${firstPrice? (firstPrice.amount/100).toLocaleString(undefined,{style:"currency",currency:"CAD"}):""}</div>
                  <button class="rs-add" data-add="${item.id}" ${firstInv.quantity === 0 ? "disabled" : ""}>Add</button>
                </div>
              </div>
            </div>`;
        }).join("");

        $grid.querySelectorAll(".rs-variant").forEach(sel=>{
          sel.onchange=()=>{
            const itemId=sel.getAttribute("data-item");
            const opt=sel.options[sel.selectedIndex];
            const priceStr=opt.getAttribute("data-price");
            const priceObj=priceStr? JSON.parse(priceStr.replaceAll('&quot;','"')) : null;
            const invQty = parseInt(opt.getAttribute("data-inventory") || "0", 10);
            const el=$grid.querySelector(`[data-price-for="${itemId}"]`);
            const addBtn=$grid.querySelector(`[data-add="${itemId}"]`);
            const invEl = sel.closest(".rs-card").querySelector(".rs-inventory");
            
            if(el) el.textContent = priceObj ? (priceObj.amount/100).toLocaleString(undefined,{style:"currency",currency:"CAD"}) : "";
            if(addBtn) {
              addBtn.disabled = invQty === 0;
              addBtn.dataset.maxQty = invQty;
            }
            if(invEl) {
              const invClass = invQty === 0 ? "out-of-stock" : invQty <= 3 ? "low-stock" : "in-stock";
              const invText = invQty === 0 ? "Out of stock" : invQty <= 3 ? `Low stock (${invQty})` : `In stock (${invQty})`;
              invEl.className = `rs-inventory ${invClass}`;
              invEl.textContent = invText;
            }
          };
        });
        
        $grid.querySelectorAll("[data-add]").forEach(btn=>{
          btn.onclick=()=>{
            const itemId=btn.getAttribute("data-add");
            const item=items.find(i=>i.id===itemId);
            const sel=$grid.querySelector(`.rs-variant[data-item="${itemId}"]`);
            const varId=sel.value;
            const v=(item.item_data?.variations||[]).find(x=>x.id===varId);
            const name=`${item.item_data?.name||"Item"} — ${(v?.item_variation_data?.name)||"Default"}`;
            const p=v?.item_variation_data?.price_money||null;
            const maxQty = parseInt(btn.dataset.maxQty || "999", 10);
            addToCart(varId,name,p,maxQty);
          };
        });
      }

      // Process purchase
      async function processPurchase(sourceId){
        const setStatus = m => { if ($status) $status.textContent = m; };

        try {
          const given_name   = document.getElementById("first").value.trim();
          const family_name  = document.getElementById("last").value.trim();
          const email_address= document.getElementById("email").value.trim();
          const phone_number = document.getElementById("phone").value.trim() || undefined;
          const noteExtra    = document.getElementById("note").value.trim();

          if (!given_name || !email_address) { 
            alert("First name and email are required."); 
            $submit.disabled = false;
            return; 
          }
          if (!cart.length) { 
            alert("Add at least one item."); 
            $submit.disabled = false;
            return; 
          }

          setStatus("Creating customer…");
          const cust = await fetch(`${PROXY_BASE}/api/customer`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ given_name, family_name, email_address, phone_number })
          }).then(r => r.json());

          if (!cust?.customer_id) {
            alert("Purchase failed: could not create/find customer.");
            setStatus("");
            $submit.disabled = false;
            return;
          }

          const line_items = cart.map(l => ({
            catalog_object_id: l.variationId,
            quantity: String(l.qty)
          }));

          // Calculate cart total before attempting payment
          const cartTotal = cart.reduce((sum, l) => {
            const price = priceNum(l.priceMoney);
            const qty = Math.max(1, parseInt(l.qty || "1", 10));
            return sum + (price * qty);
          }, 0);

          // Square doesn't allow $0 payments - check before processing
          if (cartTotal <= 0) {
            alert("Cannot process payment: Order total must be greater than $0.00.\n\nIf you're testing with free items, please add a paid item to your cart.");
            setStatus("");
            $submit.disabled = false;
            return;
          }

          const note = noteExtra ? `Order notes: ${noteExtra}` : undefined;

          setStatus("Processing payment…");
          const res = await fetch(`${PROXY_BASE}/api/purchase`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              customer_id: cust.customer_id,
              location_id: LOCATION_ID,
              line_items,
              note,
              source_id: sourceId,
            })
          });

          const data = await res.json();

          if (!res.ok || !data?.ok) {
            const errorMsg = data?.error || `HTTP ${res.status}`;
            console.error("Purchase error response:", {
              status: res.status,
              statusText: res.statusText,
              data,
              lineItems: line_items
            });
            if(data?.insufficient_inventory) {
              alert("Purchase failed: " + errorMsg + "\n\nSome items may have sold out. Please refresh and try again.");
            } else {
              alert("Purchase failed:\n" + errorMsg + "\n\nCheck the browser console for more details.");
            }
            setStatus("");
            $submit.disabled = false;
            return;
          }

          setStatus("Purchase successful!");
          alert("Thank you for your purchase! Your order has been processed.");
          
          // Clear cart
          cart.length = 0;
          saveCart();
          renderCart();
          
          // Reset form
          document.getElementById("first").value = "";
          document.getElementById("last").value = "";
          document.getElementById("email").value = "";
          document.getElementById("phone").value = "";
          document.getElementById("note").value = "";
          
          closeCart();
          setStatus("");
        } catch (err) {
          console.error("Purchase error:", err);
          alert("Purchase failed: " + (err?.message || "Unknown error"));
          setStatus("");
          $submit.disabled = false;
        }
      }

      // Submit handler
      $submit.onclick = async function(){
        if(!payments) {
          alert("Payment form not configured. Please set APPLICATION_ID in the code.");
          return;
        }
        
        if(!cart.length) {
          alert("Add at least one item to cart.");
          return;
        }
        
        $submit.disabled = true;
        $status.textContent = "Requesting payment token...";
        
        try {
          // New Square Web Payments SDK v1 API
          if (card && typeof card.tokenize === 'function') {
            const result = await card.tokenize();
            if (result.status === 'OK') {
              // Process payment with token
              processPurchase(result.token);
            } else {
              // Handle tokenization errors
              const errorMsg = result.errors?.[0]?.message || 'Payment tokenization failed';
              $status.textContent = "Payment error: " + errorMsg;
              $submit.disabled = false;
            }
          } else if (payments && typeof payments.requestCardNonce === 'function') {
            // Legacy SqPaymentForm API
            payments.requestCardNonce();
          } else {
            throw new Error("Payment method not properly initialized");
          }
        } catch (err) {
          console.error("Error tokenizing card:", err);
          $status.textContent = "Payment error: " + (err?.message || "Unknown error");
          $submit.disabled = false;
        }
      };

      // Event handlers
      $search?.addEventListener("input", renderGrid);
      $openCart?.addEventListener("click", openCart);
      $closeCart?.addEventListener("click", closeCart);
      
      // Mobile menu handlers
      document.getElementById("rs-open-cats")?.addEventListener("click", ()=>{
        document.getElementById("rs-cats")?.classList.add("mobile-open");
      });
      document.getElementById("rs-close-cats")?.addEventListener("click", ()=>{
        document.getElementById("rs-cats")?.classList.remove("mobile-open");
      });

      // Load initial data
      renderCart();
      loadCatalog();
      })();
    })();
    </script>
</body>
</html>

